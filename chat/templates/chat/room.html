{% extends 'chat/base.html' %}
{% load static %}
{% load chat_filters %}

{% block title %}Chat - {{ display_name }}{% endblock %}

{% block content %}
    <div class="chat-layout">
      <!-- Sidebar -->
      {% include 'chat/partials/sidebar_chat.html' %}

      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-header">
          <h3>{{ display_name }}</h3>
          {% if is_group %}
            <button class="btn-icon" onclick="document.getElementById('membersModal').style.display='flex'" title="View Members">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
          {% endif %}
        </div>

        <div id="chat-log" class="chat-messages">
          {% for msg in chat_messages %}
          <div class="message {% if msg.user == request.user %}sent{% else %}received{% endif %}"
            data-time="{{ msg.timestamp|date:'c' }}">
            {% if msg.user != request.user and is_group %}
                <span class="message-sender-name">{{ msg.user.full_name|default:msg.user.username }}</span>
            {% endif %}
            <div class="message-content">
              {% if msg.is_file %}
                {% if msg.is_image %}
                  <div class="file-attachment">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <a href="{{ msg.content }}" target="_blank" class="file-link">{{ msg.content|filename|truncatechars:40 }}</a>
                  </div>
                  <img src="{{ msg.content }}" class="message-image">
                {% else %}
                  <div class="file-attachment">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                      <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    <a href="{{ msg.content }}" target="_blank" class="file-link">{{ msg.content|filename|truncatechars:40 }}</a>
                  </div>
                {% endif %}
              {% else %}
                {{ msg.content }}
              {% endif %}
            </div>
            <!-- Time will be inserted by JS -->
          </div>
          {% empty %}
            <p id="no-messages-text">No messages yet.</p>
          {% endfor %}
        </div>

          <div id="typing-indicator" style="height: 20px; flex-shrink: 0; font-size: 0.8rem; color: var(--text-muted); padding-left: 10px; font-style: italic;">        </div>

        <!-- Chat Input -->
        {% if are_friends or is_group %}
          <div class="chat-input-area">
          <div class="file-input-wrapper">
            <button class="btn-icon" onclick="document.getElementById('chat-file-input').click()" title="Upload file (Max 10MB: images, PDFs, documents, archives)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
              </svg>
            </button>
            <input id="chat-file-input" type="file" style="display: none;" />
          </div>
          <span id="file-name-display" style="font-size: 0.8rem; color: var(--text-muted); margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
          <input id="chat-message-input" class="chat-input" type="text" placeholder="Type a message..." />
          <button id="chat-message-submit" class="btn btn-primary">Send</button>
        </div>
        {% else %}
          <div class="chat-input-area" style="justify-content: center; padding: 20px;">
            <div style="text-align: center; color: var(--text-muted);">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 8px;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <p style="margin: 0; font-size: 0.9rem;">You are no longer friends with {{ other_user.full_name|default:other_user.username }}.</p>
              <p style="margin: 8px 0 0 0; font-size: 0.85rem;">
                <a href="{% url 'friends:send_friend_request' other_user.id %}" style="color: var(--primary-color); text-decoration: none;">Add as friend</a> to continue chatting.
              </p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
{% endblock %}

{% block scripts %}
  {{ room_name|json_script:"room-name" }}
  {{ request.user.id|json_script:"user-id" }}
  {{ is_group|json_script:"is-group" }}
  <script>
    const my_id = JSON.parse(document.getElementById('user-id').textContent);
    const is_group = JSON.parse(document.getElementById('is-group').textContent);
  </script>
  <script src="{% static 'chat/room.js' %}?{% now 'U' %}"></script>

  {% if is_group %}
  <div id="membersModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Group Members</h3>
        <button class="btn-icon" onclick="document.getElementById('membersModal').style.display='none'">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="members-list custom-scrollbar">
        {% for member in room_members %}
          <div class="member-item">
            {% if member.avatar %}
              <img src="{{ member.avatar.url }}" class="user-avatar">
            {% else %}
              <div class="user-avatar-placeholder">{{ member.username|slice:":1"|upper }}</div>
            {% endif %}
            <span class="member-name">{{ member.full_name|default:member.username }}</span>
            {% if member == group_chat.admin %}
              <span class="member-role">Admin</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}