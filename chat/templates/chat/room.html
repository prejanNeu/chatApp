{% extends 'chat/base.html' %}
{% load static %}

{% block title %}Chat - {{ display_name }}{% endblock %}

{% block content %}
    <div class="chat-layout">
      <!-- Sidebar -->
      {% include 'chat/partials/sidebar_chat.html' %}

      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-header">
          <h3>{{ display_name }}</h3>
        </div>

        <div id="chat-log" class="chat-messages">
          {% for msg in chat_messages %}
          <div class="message {% if msg.user == request.user %}sent{% else %}received{% endif %}"
            data-time="{{ msg.timestamp|date:'c' }}">
            <div class="message-sender">{{ msg.user.username }}</div>
            <div class="message-content">
              {% if msg.is_file %}
                <a href="{{ msg.content }}" target="_blank" style="color: inherit; text-decoration: underline;">File
                  Attachment</a>
                {% if msg.is_image %}
                  <br><img src="{{ msg.content }}" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 5px;">
                {% endif %}
              {% else %}
                {{ msg.content }}
              {% endif %}
            </div>
            <!-- Time will be inserted by JS -->
          </div>
          {% empty %}
            <p>No messages yet.</p>
          {% endfor %}
        </div>

          <div id="typing-indicator" style="height: 20px; font-size: 0.8rem; color: var(--text-muted); padding-left: 10px; font-style: italic;"></div>
          <div class="chat-input-area">
          <div class="file-input-wrapper">
            <button class="btn-icon" onclick="document.getElementById('chat-file-input').click()">
              ðŸ“Ž
            </button>
            <input id="chat-file-input" type="file" style="display: none;" />
          </div>
          <span id="file-name-display" style="font-size: 0.8rem; color: var(--text-muted); margin-right: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
          <input id="chat-message-input" class="chat-input" type="text" placeholder="Type a message..." />
          <button id="chat-message-submit" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
  {{ room_name|json_script:"room-name" }}
  {{ room_name|json_script:"room-name" }}
  {{ request.user.id|json_script:"user-id" }}
  <script>
    const my_id = JSON.parse(document.getElementById('user-id').textContent);
  </script>
  <script src="{% static 'chat/room.js' %}?{% now 'U' %}"></script>
{% endblock %}